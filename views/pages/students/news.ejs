<%- include('../../partials/navbar') %>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TechMinds — Student News & Updates</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    html { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    .card { background: white; border: 1px solid rgb(226 232 240); }
    .soft { box-shadow: 0 10px 30px -12px rgba(2,6,23,.15); }
    .chip { background: rgba(37,99,235,.1); color: #1d4ed8; }
    .grid-auto { grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); }
    .prose { color: rgb(51 65 85); line-height: 1.65; }
    .prose h2 { color: rgb(15 23 42); font-weight: 700; }
    .scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar::-webkit-scrollbar-thumb { background: rgba(148,163,184,.45); border-radius: 8px; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4">
      <div class="flex h-16 items-center justify-between">
        <a href="#" class="flex items-center gap-2">
          <img src="/assets/Logo.png" alt="TechMinds" class="h-9 w-auto" onerror="this.style.display='none'"/>
          <h1 class="text-base sm:text-lg font-extrabold text-slate-900"></h1>
        </a>
        <div class="hidden md:flex items-center gap-2">
          <input id="q" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm w-72" placeholder="Search posts…" />
          <select id="sortBy" class="rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm">
            <option value="date_desc">Newest</option>
            <option value="date_asc">Oldest</option>
            <option value="title_asc">Title A–Z</option>
          </select>
        </div>

        
      </div>
    </div>
  </header>

  <!-- Filters -->
  <section class="bg-white border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex flex-wrap items-center gap-2 text-sm">
      <button data-filter="all" class="filter-pill rounded-xl border border-slate-300 bg-white px-3 py-1.5 font-medium">News/Updates/Upcoming Events/Announcements</button>
      <!-- <button data-filter="news" class="filter-pill rounded-xl border border-slate-300 bg-white px-3 py-1.5">News</button>
      <button data-filter="update" class="filter-pill rounded-xl border border-slate-300 bg-white px-3 py-1.5">Updates</button>
      <button data-filter="event" class="filter-pill rounded-xl border border-slate-300 bg-white px-3 py-1.5">Events</button>
      <button data-filter="announcement" class="filter-pill rounded-xl border border-slate-300 bg-white px-3 py-1.5">Announcements</button> -->
      <span class="ml-auto hidden sm:inline text-slate-500" id="count">—</span>
    </div>
  </section>

  <!-- Grid -->
  <main class="mx-auto max-w-7xl px-4 py-6">
    <div id="grid" class="grid grid-auto gap-4"></div>
    <div class="mt-4 flex justify-center">
      <button id="loadMore" class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm hover:bg-slate-50">Load more</button>
    </div>
  </main>

  <!-- Read Modal -->
  <div id="modal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative mx-auto mt-10 w-full max-w-3xl rounded-2xl bg-white p-6 card soft">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div id="mBadge" class="mb-2 inline-flex items-center gap-2 rounded-full px-2 py-0.5 text-xs"></div>
          <h2 id="mTitle" class="text-xl font-bold"></h2>
          <div id="mMeta" class="mt-1 text-xs text-slate-500"></div>
        </div>
        <button id="closeModal" class="rounded-md border border-slate-300 bg-white px-2 py-1 text-sm hover:bg-slate-50">Close</button>
      </div>
      <img id="mImg" class="mt-4 hidden w-full rounded-xl border border-slate-200" alt="" />
      <article id="mBody" class="prose mt-4 text-sm"></article>
      <div id="mEvent" class="mt-4 hidden text-sm">
        <div class="rounded-xl border border-slate-200 p-3 bg-slate-50">
          <div><strong>Time: </strong><span id="mTime"></span></div>
          <div><strong>Location: </strong><span id="mLocation"></span></div>
          <a id="mCta" target="_blank" class="mt-2 inline-block rounded-lg bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-blue-700">Join / Details</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="border-t border-slate-200 bg-white">
    <div class="mx-auto max-w-7xl px-4 py-6 text-sm text-slate-600">© <span id="year"></span> TechMinds Academy</div>
  </footer>

  <script>
    const $ = (s, e=document) => e.querySelector(s);
    const $$ = (s, e=document) => Array.from(e.querySelectorAll(s));

    const STORAGE = 'tma_posts_v1'; // shared storage key with your editor/admin pages

    // Map older 'announce' to 'announcement' for compatibility
    function normalizeType(t){
      if (t==='announce') return 'announcement';
      return t;
    }

    const seed = [
      { id:'p1', type:'news',        title:'New Web Dev Cohort Opens', date:'2025-11-03', image:'', content:'Applications are now open for the November Web Development cohort. Limited seats available.' },
      { id:'p2', type:'event',       title:'Career Talk with Alumni',  date:'2025-10-25', time:'14:00', location:'Online (Meet)', cta:'#', image:'', content:'Join our alumni for a candid conversation about breaking into tech.' },
      { id:'p3', type:'announcement',title:'Wi‑Fi Maintenance Friday', date:'2025-10-24', image:'', content:'Campus Wi‑Fi will be down from 6–8pm for scheduled maintenance.' },
      { id:'p4', type:'update',      title:'Cloud Lab Upgrades',       date:'2025-10-20', image:'', content:'We upgraded our cloud lab with new servers to support container workshops.' },
    ];

    // Seed if missing; read-only UI doesn't allow editing/creating
    const existing = JSON.parse(localStorage.getItem(STORAGE) || 'null');
    if (!existing) localStorage.setItem(STORAGE, JSON.stringify(seed));

    // Load and normalize
    let posts = (JSON.parse(localStorage.getItem(STORAGE)) || []).map(p=> ({...p, type: normalizeType(p.type)}));

    // State
    let filter = 'all';
    let page = 1; const per = 9;

    function badge(type){
      if (type==='news') return ['News','bg-blue-100 text-blue-700'];
      if (type==='event') return ['Event','bg-emerald-100 text-emerald-700'];
      if (type==='update') return ['Update','bg-violet-100 text-violet-700'];
      return ['Announcement','bg-amber-100 text-amber-800'];
    }

    function formatDate(iso){
      try { return new Date(iso+'T00:00:00').toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); } catch { return iso; }
    }

    function applySort(list){
      const v = $('#sortBy').value;
      const copy = [...list];
      if (v==='date_desc') return copy.sort((a,b)=> (b.date||'').localeCompare(a.date||''));
      if (v==='date_asc')  return copy.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
      if (v==='title_asc') return copy.sort((a,b)=> a.title.localeCompare(b.title));
      return copy;
    }

    function filtered(){
      const q = ($('#q')?.value||'').toLowerCase();
      let list = posts.filter(p => filter==='all' ? true : p.type===filter);
      if (q) list = list.filter(p => (p.title+" "+(p.content||'')).toLowerCase().includes(q));
      return applySort(list);
    }

    function render(){
      const list = filtered();
      $('#count').textContent = `${list.length} item${list.length===1?'':'s'}`;
      const start = 0; const end = page*per;
      const pageItems = list.slice(start,end);
      const grid = $('#grid'); grid.innerHTML = '';
      pageItems.forEach(p => grid.appendChild(card(p)));
      $('#loadMore').classList.toggle('hidden', end >= list.length);
    }

    function card(p){
      const [label,cls] = badge(p.type);
      const el = document.createElement('article');
      el.className = 'card soft rounded-2xl p-4 flex flex-col';
      const date = formatDate(p.date);
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="inline-flex items-center gap-2 rounded-full px-2 py-0.5 text-xs ${cls}">${label}</span>
          <span class="text-xs text-slate-500">${date}</span>
        </div>
        <h3 class="mt-2 text-base font-semibold">${p.title}</h3>
        <p class="mt-1 text-sm text-slate-600 line-clamp-3">${p.content||''}</p>
        <div class="mt-3 flex items-center justify-between">
          <button class="rounded-lg bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-blue-700" data-open="${p.id}">Read</button>
          ${p.type==='event' ? `<span class="text-xs chip px-2 py-0.5 rounded-full">Upcoming</span>` : ''}
        </div>`;
      return el;
    }

    // Modal open
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-open]');
      if (!btn) return;
      const id = btn.getAttribute('data-open');
      const p = posts.find(x=>x.id===id); if (!p) return;
      const [label,cls] = badge(p.type);
      $('#mBadge').className = `mb-2 inline-flex items-center gap-2 rounded-full px-2 py-0.5 text-xs ${cls}`;
      $('#mBadge').textContent = label;
      $('#mTitle').textContent = p.title;
      $('#mMeta').textContent = formatDate(p.date);
      if (p.image) { $('#mImg').src=p.image; $('#mImg').classList.remove('hidden'); } else { $('#mImg').classList.add('hidden'); }
      $('#mBody').innerHTML = (p.content||'').split(/\n+/).map(s=>`<p>${s}</p>`).join('');
      if (p.type==='event'){
        $('#mEvent').classList.remove('hidden');
        $('#mTime').textContent = p.time||'—';
        $('#mLocation').textContent = p.location||'—';
        const a = $('#mCta'); a.href = p.cta || '#'; a.classList.toggle('hidden', !p.cta);
      } else { $('#mEvent').classList.add('hidden'); }
      $('#modal').classList.remove('hidden');
    });

    $('#closeModal').addEventListener('click', ()=> $('#modal').classList.add('hidden'));
    $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') $('#modal').classList.add('hidden'); });

    // Filters
    $$('#filters .filter-pill')?.forEach(b=> b.addEventListener('click', ()=>{
      $$('#filters .filter-pill').forEach(x=>x.classList.remove('chip','font-medium'));
      b.classList.add('chip','font-medium');
      filter = b.getAttribute('data-filter'); page = 1; render();
    }));

    // Search & sort
    $('#q')?.addEventListener('input', ()=>{ page=1; render(); });
    $('#sortBy').addEventListener('change', ()=>{ page=1; render(); });

    // Year
    $('#year').textContent = new Date().getFullYear();

    // Initial UI
    // Highlight All filter
    document.querySelector('[data-filter="all"]').classList.add('chip','font-medium');
    render();
  </script>
</body>
</html>
