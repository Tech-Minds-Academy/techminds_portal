<%- include('../../partials/navbar') %>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Student News & Updates</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    @keyframes pulseHighlight { 0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, .35); } 50% { box-shadow: 0 0 0 14px rgba(59, 130, 246, 0); } }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <main class="mx-auto max-w-5xl px-4 pt-24 pb-16">
    <header class="mb-8 text-center">
      <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Latest from TechMinds</p>
      <h1 class="mt-2 text-3xl font-bold text-slate-900">Student News & Updates</h1>
      <p class="mt-3 text-sm text-slate-600">Stay on top of announcements about classes, events, and opportunities curated by the academy team.</p>
      <p id="generatedAt" class="mt-2 text-xs text-slate-500"></p>
    </header>

    <section class="mb-8 grid gap-4 rounded-3xl border border-blue-100 bg-white/70 p-6 shadow-sm sm:grid-cols-[1.1fr_0.9fr] sm:items-center" id="featuredSlot" hidden>
      <div>
        <span class="inline-flex items-center rounded-full bg-blue-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-700">Featured</span>
        <h2 class="mt-3 text-2xl font-semibold text-slate-900" data-featured-title></h2>
        <p class="mt-3 text-sm text-slate-600" data-featured-summary></p>
        <a class="mt-5 inline-flex items-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700" data-featured-link target="_blank" rel="noopener">View update</a>
      </div>
      <div class="rounded-2xl border border-blue-100 bg-blue-50/60 p-5 text-left text-sm text-slate-700">
        <h3 class="text-sm font-semibold text-blue-800">Why it matters</h3>
        <p class="mt-2" data-featured-context></p>
        <button id="saveFeatured" class="mt-4 inline-flex items-center justify-center rounded-xl border border-blue-200 bg-white px-3 py-2 text-xs font-semibold text-blue-700 shadow-sm hover:bg-blue-50">Copy link</button>
      </div>
    </section>

    <section class="mb-6 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
        <div class="w-full sm:max-w-xs">
          <label for="searchNews" class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Search updates</label>
          <input id="searchNews" type="search" class="mt-1 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Search by keyword or topic" />
        </div>
        <div class="flex flex-wrap gap-2" id="categoryFilters" aria-label="Filter by category"></div>
      </div>
    </section>

    <section id="noResults" class="mb-6 hidden rounded-2xl border border-dashed border-slate-300 bg-white p-6 text-center">
      <h2 class="text-lg font-semibold text-slate-800">No updates match your filters</h2>
      <p class="mt-2 text-sm text-slate-600">Try clearing the search term or choose a different category to see more news.</p>
      <button id="clearFilters" class="mt-4 inline-flex items-center rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">Clear filters</button>
    </section>

    <section id="newsContainer" class="grid gap-4"></section>

    <section id="emptyState" class="hidden rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center">
      <h2 class="text-lg font-semibold text-slate-800">Nothing to share right now</h2>
      <p class="mt-2 text-sm text-slate-600">Check back soonâ€”new highlights land here first. You can also follow our social channels for quick bites.</p>
    </section>
  </main>

  <template id="newsTemplate">
    <article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition hover:-translate-y-0.5 hover:shadow-md">
      <div class="flex items-center justify-between gap-3">
        <p class="text-xs font-semibold uppercase tracking-wide text-blue-600" data-category></p>
        <time class="text-xs text-slate-500" data-date></time>
      </div>
      <h2 class="mt-3 text-xl font-semibold text-slate-900" data-title></h2>
      <p class="mt-2 text-sm text-slate-600" data-summary></p>
      <a class="mt-4 inline-flex items-center text-sm font-semibold text-blue-700 hover:text-blue-800" data-link target="_blank" rel="noopener">
        <span data-link-label>Read more</span>
        <svg class="ml-1 h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 17L17 7" />
          <path d="M8 7h9v9" />
        </svg>
      </a>
    </article>
  </template>

  <script>
    const state = {
      items: [],
      filtered: [],
      activeCategory: 'all',
      searchTerm: ''
    };

    const categoryFilters = document.getElementById('categoryFilters');
    const searchNews = document.getElementById('searchNews');
    const newsContainer = document.getElementById('newsContainer');
    const emptyState = document.getElementById('emptyState');
    const noResults = document.getElementById('noResults');
    const clearFilters = document.getElementById('clearFilters');
    const featuredSlot = document.getElementById('featuredSlot');
    const newsTemplate = document.getElementById('newsTemplate');

    const featuredElements = {
      title: featuredSlot.querySelector('[data-featured-title]'),
      summary: featuredSlot.querySelector('[data-featured-summary]'),
      link: featuredSlot.querySelector('[data-featured-link]'),
      context: featuredSlot.querySelector('[data-featured-context]')
    };

    const categoryOrder = ['Events', 'Academics', 'Finance', 'Career', 'Support'];

    function sanitizeLink(link, type) {
      if (!link) return '';
      if (type === 'external' && /^https?:\/\//i.test(link)) return link;
      if (type === 'internal') {
        const cleaned = link.startsWith('/') ? link : `/${link}`;
        return cleaned.replace(/\/{2,}/g, '/');
      }
      return '';
    }

    function formatDate(date) {
      return new Date(date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function applyFilters() {
      const term = state.searchTerm.trim().toLowerCase();
      const category = state.activeCategory;
      let results = state.items.slice();

      if (category !== 'all') {
        results = results.filter(item => item.category === category);
      }

      if (term) {
        results = results.filter(item => {
          const haystack = `${item.title} ${item.summary}`.toLowerCase();
          return haystack.includes(term);
        });
      }

      state.filtered = results;
      renderList();
    }

    function renderList() {
      newsContainer.innerHTML = '';

      if (!state.items.length) {
        emptyState.classList.remove('hidden');
        noResults.classList.add('hidden');
        return;
      }

      if (!state.filtered.length) {
        noResults.classList.remove('hidden');
        emptyState.classList.add('hidden');
        return;
      }

      noResults.classList.add('hidden');
      emptyState.classList.add('hidden');

      const fragment = document.createDocumentFragment();
      state.filtered.forEach((item) => {
        const node = newsTemplate.content.cloneNode(true);
        node.querySelector('[data-category]').textContent = item.category || 'Update';
        node.querySelector('[data-date]').textContent = formatDate(item.date);
        node.querySelector('[data-title]').textContent = item.title;
        node.querySelector('[data-summary]').textContent = item.summary;
        const link = node.querySelector('[data-link]');
        const linkLabel = node.querySelector('[data-link-label]');
        const href = sanitizeLink(item.link, item.linkType);
        if (!href) {
          link.classList.add('pointer-events-none', 'opacity-60');
          link.removeAttribute('href');
          linkLabel.textContent = 'Details coming soon';
        } else {
          link.href = href;
          linkLabel.textContent = item.linkLabel || (item.linkType === 'internal' ? 'Open in portal' : 'Read more');
          if (item.linkType === 'internal') {
            link.removeAttribute('target');
            link.removeAttribute('rel');
          } else {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener');
          }
        }
        fragment.appendChild(node);
      });

      newsContainer.appendChild(fragment);
    }

    function renderCategories() {
      const unique = Array.from(new Set(state.items.map(item => item.category))).sort((a, b) => {
        const ai = categoryOrder.indexOf(a);
        const bi = categoryOrder.indexOf(b);
        if (ai === -1 && bi === -1) return a.localeCompare(b);
        if (ai === -1) return 1;
        if (bi === -1) return -1;
        return ai - bi;
      });

      const categories = ['all', ...unique];
      categoryFilters.innerHTML = '';
      categories.forEach(category => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'rounded-full border px-3 py-1 text-xs font-semibold transition focus:outline-none focus:ring-2 focus:ring-blue-200 ' +
          (state.activeCategory === category ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-slate-200 bg-slate-50 text-slate-600 hover:bg-slate-100');
        button.textContent = category === 'all' ? 'All updates' : category;
        button.addEventListener('click', () => {
          state.activeCategory = category;
          renderCategories();
          applyFilters();
        });
        categoryFilters.appendChild(button);
      });
    }

    function renderFeatured() {
      if (!state.items.length) {
        featuredSlot.hidden = true;
        return;
      }
      const featured = state.items[0];
      featuredSlot.hidden = false;
      featuredSlot.style.animation = 'pulseHighlight 3s ease-in-out';
      featuredElements.title.textContent = featured.title;
      featuredElements.summary.textContent = featured.summary;
      featuredElements.context.textContent = `This ${featured.category.toLowerCase()} update helps you stay aligned with current academy activities and key deadlines.`;
      const href = sanitizeLink(featured.link, featured.linkType);
      if (href) {
        featuredElements.link.href = href;
        featuredElements.link.textContent = featured.linkLabel || 'Open update';
        if (featured.linkType === 'internal') {
          featuredElements.link.removeAttribute('target');
          featuredElements.link.removeAttribute('rel');
        } else {
          featuredElements.link.setAttribute('target', '_blank');
          featuredElements.link.setAttribute('rel', 'noopener');
        }
      } else {
        featuredElements.link.classList.add('pointer-events-none', 'opacity-60');
        featuredElements.link.removeAttribute('href');
        featuredElements.link.textContent = 'Details coming soon';
      }
      document.getElementById('saveFeatured').onclick = async () => {
        if (!href || !navigator.clipboard) return;
        await navigator.clipboard.writeText(new URL(href, location.origin).toString());
        const button = document.getElementById('saveFeatured');
        const original = button.textContent;
        button.textContent = 'Copied!';
        button.disabled = true;
        setTimeout(() => {
          button.textContent = original;
          button.disabled = false;
        }, 2000);
      };
    }

    async function loadNews() {
      try {
        const response = await fetch('/api/news');
        if (!response.ok) throw new Error('Failed to load news.');
        const { items = [], generatedAt } = await response.json();
        state.items = Array.isArray(items) ? items.slice().sort((a, b) => new Date(b.date) - new Date(a.date)) : [];
        document.getElementById('generatedAt').textContent = generatedAt ? `Updated ${formatDate(generatedAt)}` : '';
        renderCategories();
        renderFeatured();
        applyFilters();
      } catch (error) {
        console.error(error);
        emptyState.querySelector('h2').textContent = 'We ran into a problem';
        emptyState.querySelector('p').textContent = 'Reload the page or try again later. If the issue continues, contact support.';
        emptyState.classList.remove('hidden');
      }
    }

    searchNews.addEventListener('input', (event) => {
      state.searchTerm = event.target.value;
      applyFilters();
    });

    clearFilters.addEventListener('click', () => {
      state.searchTerm = '';
      state.activeCategory = 'all';
      searchNews.value = '';
      renderCategories();
      applyFilters();
    });

    loadNews();
  </script>
</body>
</html>
